{{			
    config (			
        materialized="table",			
        alias='policy_fh_cl', 			
        database='integrate', 			
        schema='insurance',
        grants = {'ownership': ['FH_READER']},			
    )			
}}


SELECT
    FH_POLICYCATEGORY,
    POLICYCODE,
    P.CL_ADVISOR_GROUP_IDENTIFIER,
    POLICYGROUPCODE,
    FH_SERVICINGAGTCODE,
    FH_SERVICINGAGTSPLIT,
    FH_COMMISSIONINGAGTCODE,
    FH_COMMISSIONINGAGTSPLIT,
    FH_CARRIERENG,
    FH_CARRIERFR,
    POLICYNUMBER,
    PLANID,
    FH_PLANTYPE,
    FH_PLANNAMEENG,
    FH_PLANNAMEFR,
    PREMIUMAMOUNT,
    ANNUALPREMIUMAMOUNT,
    COMMPREMIUMAMOUNT,
    PAYMENTMODE,
    FACEAMOUNT,
    CREATEDBY,
    P.CREATEDDATE,
    CONTRACTDATE,
    SETTLEMENTDATE,
    EXPIRYDATE,
    RENEWALDATE,
    SENTTOICDATE,
    MAILEDDATE,
    FH_FINPOSTDATE,
    FH_STATUSCODE,
    FH_STATUSNAMEENG,
    FH_STATUSNAMEFR,
    FH_STATUSCATEGORY,
    APPCOUNT,
    FH_FYCSERVAMT,
    FH_FYCCOMMAMT,
    MGAFYOAMOUNT,
    ISSUEPROVINCE,
    FH_APPSOURCE,
    FH_APPTYPE,
    LASTCOMMISSIONPROCESSDATE,
    FIRSTOWNERCLIENTCODE,
    FIRSTINSUREDCLIENTCODE,
    ISMAINCOVERAGE,
    FH_SETTLEMENTDATE,
    FH_STARTDATE,
    FH_PREMIUM,
    FH_PREM_SERVWGT,
    FH_PREM_COMMWGT,
    APPLICATIONDATE,
    FH_PLACEDDATE,
    FH_FYCPLACED,
    FH_SERVICINGAGT_UD2,
    FH_COMMISSIONINGAGT_UD2,
    FH_COMMISSIONINGAGT_USERDEFINED2,
    FH_SERVICINGAGT_USERDEFINED2,
    FH_COMMISSIONINGAGT_REGION,
    FH_COMMISSIONINGAGT_MARKET,
    FH_COMMISSIONINGAGT_LOCATION,
    FH_SERVICINGAGT_REGION,
    FH_SERVICINGAGT_MARKET,
    FH_SERVICINGAGT_LOCATION,
    FH_COMMISSIONINGAGT_BROKERID,
    FH_COMMISSIONINGAGT_SEGMENTTAGWS,
    FH_COMMISSIONINGAGT_COS_SALES_BDC,
    FH_COMMISSIONINGAGT_COS_SALES_BDD,
    FH_COMMISSIONINGAGT_COS_SALES_RVP,
    FH_COMMISSIONINGAGT_NAME,
    FH_SERVICINGAGT_BROKERID,
    FH_SERVICINGAGT_SEGMENTTAGWS,
    COALESCE(P.FH_SERVICINGAGT_COS_SALES_BDC, B.COS_SALES_BDC) AS FH_SERVICINGAGT_COS_SALES_BDC,
    COALESCE(P.FH_SERVICINGAGT_COS_SALES_BDD, B.COS_SALES_BDD) AS FH_SERVICINGAGT_COS_SALES_BDD,
    COALESCE(P.FH_SERVICINGAGT_COS_SALES_RVP, B.COS_SALES_RVP) AS FH_SERVICINGAGT_COS_SALES_RVP,
    FH_SERVICINGAGT_NAME
FROM
    {{ ref('__base_cos_policy_fh_cl_integrate_insurance') }}  P
    LEFT JOIN {{ ref('broker_fh_cl_integrate_insurance') }} B ON P.FH_SERVICINGAGTCODE = B.AGENTCODE 
    AND B.AGENTTYPE = 'Corporate'
    AND B.USERDEFINED2 IS NULL